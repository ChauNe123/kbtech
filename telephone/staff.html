<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff KB Tech - T·ªïng ƒë√†i vi√™n</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #111; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* M√†n h√¨nh ch·∫∑n Mobile */
        #mobileBlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #mobileBlock i { font-size: 50px; color: #cc0000; margin-bottom: 20px; }
        
        /* M√ÄN H√åNH B·∫ÆT ƒê·∫¶U (Overlay) */
        #startOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; /* Z-index cao nh·∫•t */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .btn-start-work {
            background: #cc0000; color: #fff; border: 2px solid #fff;
            padding: 20px 50px; font-size: 24px; font-weight: bold;
            border-radius: 50px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 20px rgba(204, 0, 0, 0.5);
            animation: pulse 2s infinite;
            display: flex; align-items: center; gap: 10px;
        }
        .btn-start-work:hover { transform: scale(1.05); background: #ff0000; }
        .btn-start-work:disabled { background: #555; border-color: #777; cursor: not-allowed; animation: none; }

        /* Layout ch√≠nh */
        .sidebar { width: 350px; background: #1e1e1e; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .main-stage { flex: 1; position: relative; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Header Sidebar */
        .staff-info { padding: 20px; border-bottom: 1px solid #333; background: #252525; }
        .staff-info h2 { margin: 0; font-size: 18px; color: #cc0000; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-top: 5px; font-weight: bold; }
        .st-online { background: #28a745; color: #fff; }
        .st-busy { background: #ffc107; color: #000; }
        .st-offline { background: #6c757d; color: #fff; }

        /* Chat Area */
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .messages-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 90%; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg.client { background: #333; align-self: flex-start; border-bottom-left-radius: 0; }
        .msg.me { background: #cc0000; align-self: flex-end; border-bottom-right-radius: 0; }
        .msg.system { background: transparent; color: #888; font-size: 12px; text-align: center; align-self: center; width: 100%; }
        
        .chat-input { padding: 15px; background: #252525; display: flex; gap: 10px; border-top: 1px solid #333; }
        .chat-input input { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #333; color: #fff; outline: none; }
        .chat-input button { background: #cc0000; color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        /* Video Area */
        .video-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
        video#localVideo { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .overlay-wait { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #777; font-size: 20px; text-align: center; pointer-events: none; }
        
        /* Control Bar */
        .control-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 50px; backdrop-filter: blur(5px); }
        .ctrl-btn { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: #fff; }
        .ctrl-btn.on { background: #444; } .ctrl-btn.on:hover { background: #666; }
        .ctrl-btn.off { background: #cc0000; }
        .btn-end { background: #cc0000; padding: 0 30px; border-radius: 30px; width: auto; font-weight: bold; display: none; }
        .btn-end:hover { background: #ff0000; }

        /* Incoming Call */
        .incoming-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1500; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .incoming-box { background: #222; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #cc0000; box-shadow: 0 0 50px rgba(204, 0, 0, 0.5); }
        .avatar-call { width: 100px; height: 100px; background: #444; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; animation: pulse 1.5s infinite; }
        .action-buttons { margin-top: 30px; display: flex; gap: 20px; justify-content: center; }
        .btn-accept { background: #28a745; color: white; padding: 15px 40px; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .btn-reject { background: #dc3545; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <audio id="ringtone" loop>
        <source src="sound/YOUR PHONE LINGING (sound effect) - Hattyketchup.mp3" type="audio/mpeg">
    </audio>

    <div id="mobileBlock">
        <i class="fas fa-desktop"></i>
        <h2>CH·ªà D√ÄNH CHO PC</h2>
        <p>H·ªá th·ªëng Staff ch·ªâ ho·∫°t ƒë·ªông tr√™n m√°y t√≠nh ƒë·ªÉ b√†n ho·∫∑c laptop.</p>
    </div>

    <div id="startOverlay">
        <h1 style="margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px;">T·ªïng ƒë√†i KB Tech</h1>
        <button id="btnStartWork" class="btn-start-work">
            B·∫ÆT ƒê·∫¶U CA TR·ª∞C <i class="fas fa-sign-in-alt"></i>
        </button>
        <p id="loadingText" style="margin-top: 20px; color: #aaa;">B·∫•m n√∫t ƒë·ªÉ k√≠ch ho·∫°t h·ªá th·ªëng</p>
    </div>

    <div class="incoming-modal" id="incomingModal">
        <div class="incoming-box">
            <div class="avatar-call"><i class="fas fa-user" style="font-size: 40px;"></i></div>
            <h2>KH√ÅCH H√ÄNG ƒêANG G·ªåI...</h2>
            <p>Y√™u c·∫ßu h·ªó tr·ª£ tr·ª±c tuy·∫øn</p>
            <div class="action-buttons">
                <button class="btn-reject" id="btnReject"><i class="fas fa-times"></i> T·ª´ ch·ªëi</button>
                <button class="btn-accept" id="btnAnswer"><i class="fas fa-phone"></i> NGHE M√ÅY</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="staff-info">
            <h2><i class="fas fa-headset"></i> STAFF CONSOLE</h2>
            <div id="connectionStatus"><span class="status-badge st-offline">ƒêang kh·ªüi t·∫°o...</span></div>
            <div style="font-size: 12px; color: #aaa; margin-top: 5px;">ID: <span id="myIdDisplay">...</span></div>
        </div>
        <div class="chat-container">
            <div class="messages-list" id="msgList">
                <div class="msg system">Ch√†o Staff! Vui l√≤ng b·∫•m B·∫Øt ƒê·∫ßu...</div>
            </div>
            <div class="chat-input">
                <input type="text" id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="main-stage">
        <div class="no-cam-alert" id="noCamAlert" style="display:none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: orange; padding: 5px 15px; border-radius: 20px; font-size: 13px;">‚ö†Ô∏è Ch·ªâ d√πng Mic</div>
        <div class="video-wrapper">
            <div class="overlay-wait" id="videoPlaceholder">
                <i class="fas fa-video-slash" style="font-size: 40px; margin-bottom: 10px;"></i><br>
                Ch∆∞a v√†o ca tr·ª±c
            </div>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div class="control-bar">
            <button class="ctrl-btn on" id="btnToggleMic" title="B·∫≠t/T·∫Øt Mic"><i class="fas fa-microphone"></i></button>
            <button class="ctrl-btn on" id="btnToggleCam" title="B·∫≠t/T·∫Øt Camera"><i class="fas fa-video"></i></button>
            <button class="ctrl-btn btn-end" id="endCallBtn"><i class="fas fa-phone-slash"></i> &nbsp;K·∫æT TH√öC</button>
        </div>
    </div>

    <script>
        const STAFF_PEER_ID = "kbtech-hotline-vip-1";
        
        let peer = null;
        let pendingConn = null;
        let activeConn = null;
        let activeCall = null;
        let localStream = null;
        let isVideoAvailable = false;

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const btnStart = document.getElementById('btnStartWork');
        const startOverlay = document.getElementById('startOverlay');
        const loadingText = document.getElementById('loadingText');
        const ringtone = document.getElementById('ringtone');
        const incomingModal = document.getElementById('incomingModal');

        // --- X·ª¨ L√ù N√öT B·∫ÆT ƒê·∫¶U ---
        btnStart.addEventListener('click', async () => {
            // 1. Giao di·ªán ph·∫£n h·ªìi ngay l·∫≠p t·ª©c
            btnStart.disabled = true;
            btnStart.innerHTML = 'ƒêang kh·ªüi ƒë·ªông... <i class="fas fa-spinner fa-spin"></i>';
            loadingText.innerText = "ƒêang ki·ªÉm tra thi·∫øt b·ªã & k·∫øt n·ªëi t·ªïng ƒë√†i...";

            // 2. M·ªü kh√≥a √¢m thanh (Quan tr·ªçng)
            try {
                ringtone.volume = 0;
                await ringtone.play();
                ringtone.pause();
                ringtone.currentTime = 0;
                ringtone.volume = 1;
                console.log("Audio unlocked successfully");
            } catch (e) {
                console.warn("Audio auto-play blocked, but we proceed.", e);
            }

            // 3. Ki·ªÉm tra Mobile
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                document.getElementById('mobileBlock').style.display = 'flex';
                return;
            }

            // 4. Kh·ªüi t·∫°o h·ªá th·ªëng
            await initStaff();
        });

        async function initStaff() {
            logSystem("... ƒêang qu√©t thi·∫øt b·ªã ...");

            try {
                // Th·ª≠ l·∫•y Video + Audio
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                isVideoAvailable = true;
                document.getElementById('videoPlaceholder').style.display = 'none';
                logSystem("‚úÖ ƒê√£ t√¨m th·∫•y Camera & Mic.");
            } catch (err) {
                console.warn("L·ªói Camera:", err);
                try {
                    // Fallback: Ch·ªâ l·∫•y Audio
                    localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                    isVideoAvailable = false;
                    document.getElementById('noCamAlert').style.display = 'block';
                    document.getElementById('btnToggleCam').classList.add('off'); 
                    document.getElementById('btnToggleCam').disabled = true;
                    document.getElementById('videoPlaceholder').innerHTML = '<i class="fas fa-microphone"></i><br>Ch·∫ø ƒë·ªô ch·ªâ √Çm thanh';
                    logSystem("‚úÖ ƒê√£ k·∫øt n·ªëi Mic (Audio Only).");
                } catch (err2) {
                    alert("L·ªñI: Kh√¥ng t√¨m th·∫•y Mic! Vui l√≤ng ki·ªÉm tra l·∫°i d√¢y c·∫Øm v√† F5.");
                    btnStart.disabled = false;
                    btnStart.innerHTML = 'TH·ª¨ L·∫†I';
                    return;
                }
            }

            if (isVideoAvailable) {
                document.getElementById('localVideo').srcObject = localStream;
            }

            // K·∫øt n·ªëi PeerJS
            if (typeof Peer === 'undefined') {
                alert("L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán PeerJS. Vui l√≤ng ki·ªÉm tra m·∫°ng!");
                return;
            }

            peer = new Peer(STAFF_PEER_ID);

            peer.on('open', (id) => {
                // ·∫®n m√†n h√¨nh ch·ªù khi m·ªçi th·ª© ƒë√£ xong
                startOverlay.style.display = 'none';
                document.getElementById('myIdDisplay').innerText = id;
                setStatus('online');
                logSystem("üöÄ H·ªá th·ªëng S·∫¥N S√ÄNG nh·∫≠n cu·ªôc g·ªçi.");
            });

            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'unavailable-id') {
                    alert("ID ƒëang ch·∫°y ·ªü tab kh√°c! H√£y ƒë√≥ng c√°c tab c≈©.");
                } else {
                    logSystem("L·ªói m·∫°ng: " + err.type);
                }
                // N·∫øu l·ªói, hi·ªán l·∫°i n√∫t start ƒë·ªÉ th·ª≠ l·∫°i
                startOverlay.style.display = 'flex';
                btnStart.disabled = false;
                btnStart.innerHTML = 'K·∫æT N·ªêI L·∫†I';
            });

            peer.on('connection', (conn) => {
                if (activeConn) {
                    setTimeout(() => { conn.send("BUSY_NOW"); conn.close(); }, 500);
                    return;
                }
                pendingConn = conn;
                showIncomingCall();
            });
        }

        function showIncomingCall() {
            try {
                ringtone.currentTime = 0;
                ringtone.play();
            } catch(e) { console.error(e); }
            incomingModal.style.display = 'flex';
        }

        document.getElementById('btnAnswer').addEventListener('click', () => {
            ringtone.pause();
            incomingModal.style.display = 'none';
            if (pendingConn) acceptCall(pendingConn);
        });

        document.getElementById('btnReject').addEventListener('click', () => {
            ringtone.pause();
            incomingModal.style.display = 'none';
            if (pendingConn) {
                pendingConn.send("BUSY_NOW");
                setTimeout(() => pendingConn.close(), 500);
                pendingConn = null;
            }
        });

        function acceptCall(conn) {
            activeConn = conn;
            pendingConn = null;
            setStatus('busy');
            document.getElementById('endCallBtn').style.display = 'flex';
            logSystem("üìû ƒê√É K·∫æT N·ªêI V·ªöI KH√ÅCH H√ÄNG!");

            const call = peer.call(conn.peer, localStream);
            activeCall = call;

            conn.on('data', (data) => {
                if(data === 'USER_DISCONNECT') endSession();
                else addMessage(data, 'client');
            });
            conn.on('close', endSession);
        }

        // Logic Chat & Control
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        
        function sendMessage() {
            const text = msgInput.value.trim();
            if (text && activeConn) {
                activeConn.send(text);
                addMessage(text, 'me');
                msgInput.value = '';
            }
        }
        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage() });

        document.getElementById('endCallBtn').addEventListener('click', () => {
            if(activeConn) activeConn.send("STAFF_END");
            endSession();
        });

        document.getElementById('btnToggleMic').addEventListener('click', function() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                this.classList.toggle('on'); this.classList.toggle('off');
                this.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            }
        });

        document.getElementById('btnToggleCam').addEventListener('click', function() {
            if (!localStream || !isVideoAvailable) return; 
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                this.classList.toggle('on'); this.classList.toggle('off');
                this.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                document.getElementById('videoPlaceholder').style.display = videoTrack.enabled ? 'none' : 'block';
            }
        });

        function endSession() {
            if (activeConn) { activeConn.close(); activeConn = null; }
            if (activeCall) { activeCall.close(); activeCall = null; }
            setStatus('online');
            document.getElementById('endCallBtn').style.display = 'none';
            logSystem("‚èπÔ∏è ƒê√É K·∫æT TH√öC CU·ªòC G·ªåI.");
        }

        function setStatus(state) {
            const el = document.getElementById('connectionStatus');
            if (state === 'online') el.innerHTML = '<span class="status-badge st-online">S·∫µn s√†ng</span>';
            if (state === 'busy') el.innerHTML = '<span class="status-badge st-busy">ƒêang b·∫≠n</span>';
        }

        function logSystem(text) {
            const div = document.createElement('div');
            div.className = 'msg system';
            div.innerText = text;
            document.getElementById('msgList').appendChild(div);
        }

        function addMessage(msg, type) {
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            if(msg.includes('http')) div.innerHTML = msg.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:yellow;">$1</a>');
            else div.innerText = msg;
            const list = document.getElementById('msgList');
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }
    </script>
</body>
</html>


